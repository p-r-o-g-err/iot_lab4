import requests
import time
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))) # –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ config
from config import *
from database import save_temperature_data
from datetime import datetime
import requests
from utils import send_telegram_message

class TemperatureController:
    def __init__(self):
        self.current_temperature = None
        
    def check_temperature(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"""
        try:
            response = requests.get(f"{SENSOR_URL}/temperature")
            temp_data = response.json()
            self.current_temperature = temp_data['temperature']
            
            if self.current_temperature < -15:
                message = f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {self.current_temperature}¬∞C: –•–æ–ª–æ–¥–Ω–æ! ‚ùÑÔ∏è"
            elif -15 <= self.current_temperature <= 0:
                message = f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {self.current_temperature}¬∞C: –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ. üå¨Ô∏è"
            elif 0 < self.current_temperature < 15:
                message = f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {self.current_temperature}¬∞C: –°–∫–æ—Ä–æ –ª–µ—Ç–æ! üå∏"
            else:
                message = f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {self.current_temperature}¬∞C: –ñ–∞—Ä–∫–æ! ‚òÄÔ∏è"

            print(message)

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            save_temperature_data(timestamp, self.current_temperature)

            send_telegram_message(message)
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã: {e}")


if __name__ == "__main__":
    controller = TemperatureController()
    try:
        print("–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–ø—É—â–µ–Ω")
        while True:
            controller.check_temperature()
            time.sleep(2)
    except KeyboardInterrupt:
        print("\n–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")